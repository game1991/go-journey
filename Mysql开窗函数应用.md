> 近期的工作项目中有关于服务项目程序升级，需要对数据进行批量更新处理，近期的工作项目中有关于服务项目程序升级，需要对数据进行批量更新处理，针对批量更新采用不同方案带来的不同的处理效率，以此推荐大家一些参考。

## 【MySql】Update批量更新与批量更新多条记录的不同值实现方法

MySQL更新单条单字段的语句如下：

```sql
UPDATE tablename SET fieldname = 'value' WHERE id = 'id';
```
更新多条同一字段为同一个值，语句如下：

```sql
UPDATE tablename SET fieldname = 'value' WHERE id in ('value1','value2','value3',....);
```

### 1、 如果需要更新多条数据为不同的值，采用for循环的方式去更新，如下：
```go
// ids代表你需要批量更新的对象id，data1,data2是当对象为该id时需要更改的值；注意此时data1,data2也是变量
for _,item:=range ids{
		sql=`Update tablename SET fieldname1=?,fieldname2=? WHERE ID =?`
		db.Exec(sql,data1,data2,item)
	}

```

一条sql指令操作update一次，这样性能很差，也很容易造成阻塞。

### 2、可以用一条sql语句实现批量更新吗？mysql可以使用when then 的语句实现。

```sql
UPDATE tablename 
    SET fieldname = CASE id 
        WHEN 1 THEN 'value1'
        WHEN 2 THEN 'value2'
        WHEN 3 THEN 'value3'
    END
WHERE id IN (1,2,3)
```

这句sql的意思是，更新fieldname 字段，如果id=1 则fieldname 的值为value1，如果id=2 则 fieldname 的值为value2，如果id=3 则 fieldname 的值为value3。

此时的条件语句都写在了一起。
这里的where部分不影响代码的执行，但是会提高sql执行的效率。确保sql语句仅执行需要修改的行数，这里只有3条数据进行更新，而where子句确保只有3行数据执行。

**如果更新多个字段的值的话，sql语句如下**：

```sql
UPDATE tablename 
    SET fieldname = CASE id 
        WHEN 1 THEN 'value1' 
        WHEN 2 THEN 'value2' 
        WHEN 3 THEN 'value3' 
    END, 
    fieldname2 = CASE id 
        WHEN 1 THEN 'new value1'
        WHEN 2 THEN 'new value2'
        WHEN 3 THEN 'new value3'
    END
WHERE id IN (1,2,3)
```

通过sql执行语句的速度上来看，第二种方法是更高效的方式，一条语句就可以完成不同的字段不同值的批量更新，但是此条语句对于数据的构建有一些不友好，条件when 和 then 这些对象的值如果是变量放在sql语句中去执行，构建的sql 容易造成sql注入，因此这种方案也存在瓶颈。

## 【MySql】开窗函数的实践
> 就我的项目情况而言，我当时的需求是需要将tableB的筛选出来的数据进行批量更新到tableA的表中，通过联表join更新可以实现，但是当时遇到的难点是在于这些筛选出来的数据如何select出来。

场景是：tableB中存在1对多的数据，一个recordID对应多条数据，我只需要提取出来最新的一条
此时使用开窗函数ROW_NUMBER() over 可以筛选出我们需要的数据，语句如下：

```sql
SELECT RecordID,Content,CreateAt,
ROW_NUMBER() over(PARTITION by RecordID ORDER BY CreateAt DESC)
AS `rownum` FROM tableB 
```
| RecordID  | Content  | CreateAt  |  rownum |
| ------------ | ------------ | ------------ | ------------ |
| 1 |  content1 | 2020-12-15 05:31:06  | 1 |
| 1 |  content2 | 2020-12-08 10:08:04  | 2 |
| 1 |  content3 | 2020-12-08 10:05:07  | 3 |
| 1 |  content4 |  2020-12-02 09:25:54 | 4 |
| 2 | content1  | 2020-10-20 11:20:18  | 1 |
| 3 | content1  | 2020-10-09 07:15:56  | 1 |
| 3 | content2  | 2020-10-09 07:12:41  | 2 |
| 3 | content3  | 2020-09-23 11:40:38  | 3 |
| 4  | content1 | 2020-10-20 11:34:16  | 1 |

通过这个ROW_NUMBER() over 实现了1对多数据的序列排号，此时我where 条件就可以设置为 rownum =1 完成我们的需求

加上update 联表join 完成批量更新，完整sql语句如下：

```sql
UPDATE tabaleA JOIN (
SELECT RecordID,Content FROM (
SELECT *,ROW_NUMBER() over(PARTITION by RecordID ORDER BY CreateAt DESC) AS `rownum` FROM tableB 
WHERE Action='pass' AND CertifType='enterprise'
) tt WHERE tt.rownum=1
) AS source SET tabaleA.Content=source.Content,tabaleA.IsCertified=TRUE 
WHERE enterprise_certify.ID=source.RecordID
```
从上面实践开窗函数ROW_NUMBER() over来看，同样是一条sql语句完成批量更新，重点是解决了数据的筛选问题。
|id|uid|login_time|
|-|-|-|
|1|	1	|2020-04-10 12:02:00	2020-04-10 12:03:23|
|2|	1	|2020-04-10 12:03:23	2020-04-10 12:03:59|
|3|	1	|2020-04-10 12:03:59	2020-04-10 12:06:34|
|4|	1	|2020-04-10 12:06:34	|
|5|	2	|2020-04-10 13:00:00	2020-04-10 13:02:00|
|6|	2	|2020-04-10 13:02:00	2020-04-10 13:02:45|
|7|	2	|2020-04-10 13:02:45	|



|id |uid |login_time |lead_time |相差秒数 |相差分钟数|
|-|-|-|-|-|-|
|1	|1	|2020-04-10 12:02:00|	2020-04-10 12:03:23	|83|	1.383|
|2	|1	|2020-04-10 12:03:23|	2020-04-10 12:03:59	|36|	0.600|
|3	|1	|2020-04-10 12:03:59|	2020-04-10 12:06:34	|155|	2.583|
|4	|1	|2020-04-10 12:06:34|			||
|5	|2	|2020-04-10 13:00:00|	2020-04-10 13:02:00	|120|	2.000|
|6	|2	|2020-04-10 13:02:00|	2020-04-10 13:02:45	|45|	0.750|
|7	|2	|2020-04-10 13:02:45|			||

|id |uid |login_time |lead_time |相差秒数 |
|-|-|-|-|-|
|1	|1	|2020-04-10 12:02:00|	(Null)	|(Null)|
|2	|1	|2020-04-10 12:03:23|	2020-04-10 12:02:00|	83|
|3	|1	|2020-04-10 12:03:59|	2020-04-10 12:03:23|	36|
|4	|1	|2020-04-10 12:06:34|	2020-04-10 12:03:59|	155|
|5	|2	|2020-04-10 13:00:00|	(Null)	|(Null)|
|6	|2	|2020-04-10 13:02:00|	2020-04-10 13:00:00|	120|
|7	|2	|2020-04-10 13:02:45|	2020-04-10 13:02:00|	45|


|sid|sname|gender|cname|num|first_value用法|
|-|-|-|-|-|-|
|12	|张三	|男	|体育	|87|	87|
|52	|刘三	|男	|体育	|87|	87|
|8	|钢蛋	|女	|体育	|68|	87|
|16	|张一	|男	|体育	|67|	87|
|20	|张二	|女	|体育	|67|	87|
|24	|张四	|男	|体育	|67|	87|
|28	|铁锤	|女	|体育	|67|	87|
|32	|李三	|男	|体育	|67|	87|
|36	|李一	|男	|体育	|67|	87|
|40	|李二	|女	|体育	|43|	87|
|44	|李四	|男	|体育	|43|	87|
|48	|如花	|女	|体育	|43|	87|
|23	|张四	|男	|物理	|100|	100|
|27	|铁锤	|女	|物理	|100|	100|
|31	|李三	|男	|物理	|100|	100|
|35	|李一	|男	|物理	|88|	100|
|39	|李二	|女	|物理	|77|	100|
|43	|李四	|男	|物理	|77|	100|
|47	|如花	|女	|物理	|77|	100|
|11	|张三	|男	|物理	|66|	100|
|15	|张一	|男	|物理	|11|	100|
|19	|张二	|女	|物理	|11|	100|
|2	|理解	|男	|物理	|9|	100|
|34	|李一	|男	|生物	|91|	91|
|38	|李二	|女	|生物	|90|	91|
|42	|李四	|男	|生物	|90|	91|
|46	|如花	|女	|生物	|90|	91|
|14	|张一	|男	|生物	|79|	91|
|18	|张二	|女	|生物	|79|	91|
|10	|张三	|男	|生物	|77|	91|
|1	|理解	|男	|生物	|10|	91|
|22	|张四	|男	|生物	|9|	91|
|26	|铁锤	|女	|生物	|9|	91|
|30	|李三	|男	|生物	|9|	91|
|6	|钢蛋	|女	|生物	|8|	91|
|17	|张一	|男	|美术	|100|	100|
|21	|张二	|女	|美术	|100|	100|
|25	|张四	|男	|美术	|100|	100|
|9	|钢蛋	|女	|美术	|99	|100|
|13	|张三	|男	|美术	|99	|100|
|29	|铁锤	|女	|美术	|88	|100|
|33	|李三	|男	|美术	|88	|100|
|41	|李二	|女	|美术	|87	|100|
|45	|李四	|男	|美术	|87	|100|
|49	|如花	|女	|美术	|87	|100|
|5	|理解	|男	|美术	|66	|100|
|37	|李一	|男	|美术	|22	|100|



|sid|sname|gender|cname|num|last_value用法|
|-|-|-|-|-|-|
|8	|钢蛋	|女|	体育|	68	|87|
|12	|张三	|男|	体育|	87	|87|
|16	|张一	|男|	体育|	67	|87|
|20	|张二	|女|	体育|	67	|87|
|24	|张四	|男|	体育|	67	|87|
|28	|铁锤	|女|	体育|	67	|87|
|32	|李三	|男|	体育|	67	|87|
|36	|李一	|男|	体育|	67	|87|
|40	|李二	|女|	体育|	43	|87|
|44	|李四	|男|	体育|	43	|87|
|48	|如花	|女|	体育|	43	|87|
|52	|刘三	|男|	体育|	87	|87|
|2	|理解	|男|	物理|	9	|77|
|11	|张三	|男|	物理|	66	|77|
|15	|张一	|男|	物理|	11	|77|
|19	|张二	|女|	物理|	11	|77|
|23	|张四	|男|	物理|	100	|77|
|27	|铁锤	|女|	物理|	100	|77|
|31	|李三	|男|	物理|	100	|77|
|35	|李一	|男|	物理|	88	|77|
|39	|李二	|女|	物理|	77	|77|
|43	|李四	|男|	物理|	77	|77|
|47	|如花	|女|	物理|	77	|77|
|1	|理解	|男|	生物|	10	|90|
|6	|钢蛋	|女|	生物|	8	|90|
|10	|张三	|男|	生物|	77	|90|
|14	|张一	|男|	生物|	79	|90|
|18	|张二	|女|	生物|	79	|90|
|22	|张四	|男|	生物|	9	|90|
|26	|铁锤	|女|	生物|	9	|90|
|30	|李三	|男|	生物|	9	|90|
|34	|李一	|男|	生物|	91	|90|
|38	|李二	|女|	生物|	90	|90|
|42	|李四	|男|	生物|	90	|90|
|46	|如花	|女|	生物|	90	|90|
|5	|理解	|男|	美术|	66	|87|
|9	|钢蛋	|女|	美术|	99	|87|
|13	|张三	|男|	美术|	99	|87|
|17	|张一	|男|	美术|	100	|87|
|21	|张二	|女|	美术|	100	|87|
|25	|张四	|男|	美术|	100	|87|
|29	|铁锤	|女|	美术|	88	|87|
|33	|李三	|男|	美术|	88	|87|
|37	|李一	|男|	美术|	22	|87|
|41	|李二	|女|	美术|	87	|87|
|45	|李四	|男|	美术|	87	|87|
|49	|如花	|女|	美术|	87	|87|



|sid|sname|gender|cname|num|last_value用法|
|-|-|-|-|-|-|
|12	|张三	|男	|体育|	87	|43|
|52	|刘三	|男	|体育|	87	|43|
|8	|钢蛋	|女	|体育|	68	|43|
|16	|张一	|男	|体育|	67	|43|
|20	|张二	|女	|体育|	67	|43|
|24	|张四	|男	|体育|	67	|43|
|28	|铁锤	|女	|体育|	67	|43|
|32	|李三	|男	|体育|	67	|43|
|36	|李一	|男	|体育|	67	|43|
|40	|李二	|女	|体育|	43	|43|
|44	|李四	|男	|体育|	43	|43|
|48	|如花	|女	|体育|	43	|43|
|23	|张四	|男	|物理|	100	|9|
|27	|铁锤	|女	|物理|	100	|9|
|31	|李三	|男	|物理|	100	|9|
|35	|李一	|男	|物理|	88	|9|
|39	|李二	|女	|物理|	77	|9|
|43	|李四	|男	|物理|	77	|9|
|47	|如花	|女	|物理|	77	|9|
|11	|张三	|男	|物理|	66	|9|
|15	|张一	|男	|物理|	11	|9|
|19	|张二	|女	|物理|	11	|9|
|2	|理解	|男	|物理|	9	|9|
|34	|李一	|男	|生物|	91	|8|
|38	|李二	|女	|生物|	90	|8|
|42	|李四	|男	|生物|	90	|8|
|46	|如花	|女	|生物|	90	|8|
|14	|张一	|男	|生物|	79	|8|
|18	|张二	|女	|生物|	79	|8|
|10	|张三	|男	|生物|	77	|8|
|1	|理解	|男	|生物|	10	|8|
|22	|张四	|男	|生物|	9	|8|
|26	|铁锤	|女	|生物|	9	|8|
|30	|李三	|男	|生物|	9	|8|
|6	|钢蛋	|女	|生物|	8	|8|
|17	|张一	|男	|美术|	100	|22|
|21	|张二	|女	|美术|	100	|22|
|25	|张四	|男	|美术|	100	|22|
|9	|钢蛋	|女	|美术|	99	|22|
|13	|张三	|男	|美术|	99	|22|
|29	|铁锤	|女	|美术|	88	|22|
|33	|李三	|男	|美术|	88	|22|
|41	|李二	|女	|美术|	87	|22|
|45	|李四	|男	|美术|	87	|22|
|49	|如花	|女	|美术|	87	|22|
|5	|理解	|男	|美术|	66	|22|
|37	|李一	|男	|美术|	22	|22|



|year|month|sales_num|累计销售额|
|-|-|-|-|
|2016|	1|	5840|	5840|
|2016|	2|	5780|	11620|
|2016|	3|	4300|	15920|
|2016|	4|	4760|	20680|
|2016|	5|	3630|	24310|
|2016|	6|	4130|	28440|
|2016|	7|	4350|	32790|